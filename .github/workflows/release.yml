name: Build and publish terraform-bundle package

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.2.3)'
        required: true
      name:
        description: 'Release name (optional)'
        required: false
      body:
        description: 'Release body/notes (optional)'
        required: false
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Download terraform-bundle binary
        run: |
          set -euo pipefail
          version="0.1.0"
          url="https://github.com/hashicorp-services/terraform-bundle-binary/releases/download/${version}/terraform_bundle_linux_amd64_v0.15.5"
          echo "Downloading terraform-bundle from: $url"
          # -f: fail on HTTP errors; -S: show error; -L: follow redirects; retry to reduce flakiness
          curl -fSL --retry 3 --retry-delay 5 -o terraform-bundle "$url"
          chmod +x terraform-bundle

      - name: Validate downloaded terraform-bundle
        run: |
          set -euo pipefail
          if [ ! -s terraform-bundle ]; then
            echo "Downloaded file is empty" >&2
            exit 1
          fi
          # prefer 'file' output; on runners 'file' should exist
          file_out=$(file --brief terraform-bundle || true)
          echo "file: $file_out"
          # Check for ELF (linux binary) or other executables (Mach-O for mac)
          if echo "$file_out" | grep -Ei "elf|executable|mach-o" >/dev/null; then
            echo "Downloaded terraform-bundle looks like a binary"
          else
            echo "Downloaded terraform-bundle does not look like a native binary. Printing head for debugging:" >&2
            echo "---- BEGIN FILE HEAD ----" >&2
            head -n 50 terraform-bundle >&2 || true
            echo "---- END FILE HEAD ----" >&2
            echo "If this is an HTML error page, the download URL may be incorrect or the release/tag does not exist." >&2
            exit 1
          fi

      - name: Show terraform-bundle version
        run: |
          set -euo pipefail
          ./terraform-bundle -version || true

      - name: Run terraform-bundle package
        run: |
          ./terraform-bundle package -os=linux -arch=amd64 config.hcl

      - name: Collect release artifacts
        run: |
          mkdir -p release-artifacts
          # Move common archive/bundle patterns into release-artifacts if present
          shopt -s nullglob || true
          for f in *.zip *.tar.gz *.tgz terraform_bundle* bundle* *.tar; do
            if [ -f "$f" ]; then
              mv "$f" release-artifacts/ || true
            fi
          done
          echo "Collected files:"
          ls -la release-artifacts || true

      - name: Create GitHub Release and upload artifacts
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.name || github.ref_name }}
          body: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.body || '' }}
          files: release-artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
